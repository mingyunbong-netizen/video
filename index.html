<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ìƒ ë¹„êµ ë° 3D ëª¨ë¸ ë·°ì–´</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* ----------------------------------- */
        /* ìƒë‹¨: ì˜ìƒ ë¹„êµ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        /* ----------------------------------- */
        .top-comparison-section {
            width: 100%;
            display: flex;
            justify-content: center; /* ë·°ì–´ ì¤‘ì•™ ì •ë ¬ */
            padding: 30px 0;
            box-sizing: border-box;
            background-color: #f7f7f7; /* ì„¹ì…˜ ë°°ê²½ìƒ‰ */
        }

        .comparison-container {
            display: flex;
            width: 1000px; /* ê³ ì • í¬ê¸° ìœ ì§€ */
            height: 500px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* ì™¼ìª½ íŒ¨ë„: ì—…ë¡œë“œí•œ ì˜ìƒ (500px x 500px ê³ ì •) */
        .left-panel {
            width: 500px;
            height: 500px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„: ì›¹ìº  í”¼ë“œ (500px x 500px ê³ ì •) */
        .right-panel {
            width: 500px;
            height: 500px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            background-color: #333333;
        }

        /* ì˜ìƒ ìŠ¤íƒ€ì¼ */
        #my-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ì›¹ìº  í™”ë©´ ìŠ¤íƒ€ì¼ */
        #webcam-feed {
            width: 500px;
            height: 500px;
            background-color: #000;
            object-fit: cover;
            border: none;
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
        }

        .loading-text {
            color: white;
            font-size: 1.2em;
            text-align: center;
            position: absolute; /* right-panel ë‚´ì—ì„œ ìƒëŒ€ì  ìœ„ì¹˜ ì§€ì • */
            width: 500px;
        }

        /* ----------------------------------- */
        /* í•˜ë‹¨: 3D ë·°ì–´ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        /* ----------------------------------- */

        #threejs-container {
            width: 100vw;
            /* 3D ë·°ì–´ì˜ ë†’ì´. í•„ìš”ì— ë”°ë¼ ì¡°ì ˆí•˜ì„¸ìš”. */
            height: 70vh; 
            overflow: hidden;
            cursor: grab; /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì»¤ì„œ */
        }

        /* Three.js ìº”ë²„ìŠ¤ê°€ ì´ ì»¨í…Œì´ë„ˆ ì•ˆì— ìœ„ì¹˜í•©ë‹ˆë‹¤. */
        #threejs-container canvas {
            display: block; /* ìº”ë²„ìŠ¤ ì•„ë˜ ê³µë°± ì œê±° */
        }
    </style>
</head>
<body>

    <div class="top-comparison-section">
        <div class="comparison-container">
            <div class="left-panel">
                <video id="my-video" autoplay loop muted playsinline>
                    <source id="video-source" src="base.mp4" type="video/mp4">
                    ì£„ì†¡í•©ë‹ˆë‹¤. ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ëŠ” ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </video>
            </div>

            <div class="right-panel">
                <div id="loading-message" class="loading-text">
                    ì›¹ìº  ì ‘ê·¼ì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤... í—ˆìš©í•´ ì£¼ì„¸ìš”.
                </div>
                <video id="webcam-feed" autoplay playsinline style="display: none;"></video>
            </div>
        </div>
    </div>

    <div id="threejs-container">
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // ----------------------------------------------------
        // A. ì›¹ìº /ì˜ìƒ ë¹„êµ ì„¹ì…˜ JavaScript
        // ----------------------------------------------------
        const videoElement = document.getElementById('webcam-feed');
        const loadingMessage = document.getElementById('loading-message');
        const myVideo = document.getElementById('my-video'); // ì™¼ìª½ ì˜ìƒ ìš”ì†Œ
        const videoSource = document.getElementById('video-source'); // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ìš”ì†Œ

        // 1. ë¸Œë¼ìš°ì € ì •ì±…ì„ ìš°íšŒí•˜ê¸° ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸
        if (myVideo) {
            myVideo.play().catch(error => {
                console.log("ìë™ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ í´ë¦­í•´ ì£¼ì„¸ìš”.");
                document.addEventListener('click', () => {
                    myVideo.play().catch(e => console.log("ì¬ìƒ ì‹¤íŒ¨:", e));
                }, { once: true });
            });
        }

        // 2. ì›¹ìº  ì ‘ê·¼ ìš”ì²­ í•¨ìˆ˜
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                loadingMessage.style.display = 'none';
                videoElement.style.display = 'block';
                videoElement.srcObject = stream;
            } catch (err) {
                console.error("ì›¹ìº  ì ‘ê·¼ ê¶Œí•œ ê±°ë¶€ ë˜ëŠ” ì˜¤ë¥˜ ë°œìƒ:", err);
                loadingMessage.innerText = "ì›¹ìº  ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.";
                loadingMessage.style.color = '#ff6b6b';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›¹ìº  ì‹œì‘
        window.onload = startWebcam;


        // ----------------------------------------------------
        // B. 3D ëª¨ë¸ ë·°ì–´ ì„¹ì…˜ JavaScript (Three.js)
        // ----------------------------------------------------
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const threeJsContainer = document.getElementById('threejs-container');

        // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        let intersectedObject = null;
        let originalScale = new THREE.Vector3(); // ì›ë˜ ìŠ¤ì¼€ì¼ ì €ì¥
        let rotationSpeed = 0.005; // ìë™ íšŒì „ ì†ë„
        let autoRotateTween = null; // ìë™ íšŒì „ íŠ¸ìœˆ ì• ë‹ˆë©”ì´ì…˜
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // ğŸŒŸğŸŒŸğŸŒŸ ëª¨ë¸ í¬ê¸° ë° ë°°ì¹˜ ì„¤ì • (ì´ê³³ë§Œ ìˆ˜ì •í•˜ì„¸ìš”!) ğŸŒŸğŸŒŸğŸŒŸ
        const modelsToLoad = [
            { name: 'shoes.glb', scale: 10, video: 'shoes_video.mp4' }, // ì˜ˆì‹œ: shoes_video.mp4 ì¶”ê°€
            { name: 'bag.glb', scale: 7, video: 'bag_video.mp4' },
            { name: 'ball.glb', scale: 5, video: 'ball_video.mp4' },
            { name: 'book.glb', scale: 10, video: 'book_video.mp4' },
            { name: 'close.glb', scale: 5, video: 'close_video.mp4' },
            { name: 'glasses.glb', scale: 20, video: 'glasses_video.mp4' },
            { name: 'guard.glb', scale: 10, video: 'guard_video.mp4' },
            { name: 'persimmon.glb', scale: 20, video: 'persimmon_video.mp4' },
        ];

        const FIXED_POSITION_Y = -4.0; 
        const FIXED_POSITION_Z = 0.0;
        const MODEL_SPACING_X = 3.0;
        const HOVER_SCALE_FACTOR = 1.2; // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ í™•ëŒ€ ë¹„ìœ¨
        const VIDEO_RESET_DELAY = 3000; // ë¹„ë””ì˜¤ êµì²´ í›„ base.mp4ë¡œ ëŒì•„ì˜¤ëŠ” ì‹œê°„ (ms)
        const BASE_VIDEO_PATH = "base.mp4"; // ê¸°ë³¸ ë¹„ë””ì˜¤ ê²½ë¡œ
        // ğŸŒŸğŸŒŸğŸŒŸ ------------------------------------ ğŸŒŸğŸŒŸğŸŒŸ


        // 1. ê¸°ë³¸ 3ìš”ì†Œ ì„¤ì •
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff); // ë°°ê²½ìƒ‰: ì—°í•œ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ (3D ì„¹ì…˜ êµ¬ë¶„ì„ ìœ„í•´)

        const camera = new THREE.PerspectiveCamera(50, threeJsContainer.clientWidth / threeJsContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, 0, 15);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(threeJsContainer.clientWidth, threeJsContainer.clientHeight);
        threeJsContainer.appendChild(renderer.domElement); 

        // 2. ì¡°ëª… ì„¤ì •
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(5, 10, 7).normalize();
        scene.add(directionalLight);

        // 3. ì»¨íŠ¸ë¡¤ ì„¤ì •
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, FIXED_POSITION_Y, 0); // ì¹´ë©”ë¼ íƒ€ê²Ÿì„ ëª¨ë¸ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ì •
        controls.enablePan = false;
        controls.enableRotate = true; // ê¶¤ë„ íšŒì „ í™œì„±í™” (ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ëª¨ë¸ ê°œë³„ íšŒì „ì€ ë³„ë„ ì²˜ë¦¬)
        controls.maxDistance = 20;
        controls.minDistance = 5;


        // 4. GLB íŒŒì¼ ë¡œë“œ!
        const loader = new GLTFLoader();
        const modelCount = modelsToLoad.length;
        const startX = -((modelCount - 1) * MODEL_SPACING_X) / 2;

        modelsToLoad.forEach((modelInfo, index) => {
            loader.load(
                modelInfo.name,
                function (gltf) {
                    const model = gltf.scene;

                    // Xì¶• ì¼ë ¬ ìœ„ì¹˜ ê³„ì‚°
                    model.position.x = startX + (index * MODEL_SPACING_X);
                    // Yì¶• (ë†’ì´) = -4.0 ê³ ì •
                    model.position.y = FIXED_POSITION_Y;
                    // Zì¶• (ê¹Šì´) = 0.0 ê³ ì •
                    model.position.z = FIXED_POSITION_Z;

                    // ëª¨ë¸ í¬ê¸° ë° userData ì„¤ì •
                    model.scale.set(modelInfo.scale, modelInfo.scale, modelInfo.scale);
                    model.userData.modelName = modelInfo.name;
                    model.userData.modelVideo = modelInfo.video; // ëª¨ë¸ì— í•´ë‹¹í•˜ëŠ” ë¹„ë””ì˜¤ ê²½ë¡œ ì €ì¥
                    model.userData.originalScale = model.scale.clone(); // ì›ë˜ ìŠ¤ì¼€ì¼ ì €ì¥

                    scene.add(model);
                },
                undefined,
                function (error) {
                    console.error(`ëª¨ë¸ ë¡œë“œ ì¤‘ ì—ëŸ¬ ë°œìƒ: ${modelInfo.name}`, error);
                }
            );
        });


        // 5. ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë§ˆìš°ìŠ¤ ì˜¤ë²„, ì•„ì›ƒ, í´ë¦­)
        renderer.domElement.addEventListener('mousemove', onThreeJsMouseMove, false);
        renderer.domElement.addEventListener('click', onThreeJsClick, false);
        renderer.domElement.addEventListener('mouseleave', onThreeJsMouseLeave, false);


        let currentIntersected = null; // í˜„ì¬ ë§ˆìš°ìŠ¤ ì˜¤ë²„ëœ ëª¨ë¸

        function onThreeJsMouseMove(event) {
            // ë§ˆìš°ìŠ¤ ì¢Œí‘œë¥¼ Three.js ì •ê·œí™” ì¢Œí‘œë¡œ ë³€í™˜
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                let target = intersects[0].object;
                while (target.parent && target.parent !== scene) {
                    target = target.parent;
                }

                if (target.parent === scene && target !== currentIntersected) {
                    // ì´ì „ì— ì˜¤ë²„ëœ ëª¨ë¸ì´ ìˆë‹¤ë©´ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
                    if (currentIntersected) {
                        currentIntersected.scale.copy(currentIntersected.userData.originalScale);
                        // ìë™ íšŒì „ ë©ˆì¶”ê¸°
                        if (currentIntersected.userData.autoRotateInterval) {
                            clearInterval(currentIntersected.userData.autoRotateInterval);
                            currentIntersected.userData.autoRotateInterval = null;
                        }
                    }

                    // ìƒˆë¡­ê²Œ ì˜¤ë²„ëœ ëª¨ë¸ ì„¤ì • ë° í™•ëŒ€
                    currentIntersected = target;
                    currentIntersected.scale.multiplyScalar(HOVER_SCALE_FACTOR);

                    // ìë™ íšŒì „ ì‹œì‘
                    if (!currentIntersected.userData.autoRotateInterval) {
                        currentIntersected.userData.autoRotateInterval = setInterval(() => {
                            currentIntersected.rotation.y += rotationSpeed * 5; // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì¢€ ë” ë¹ ë¥´ê²Œ íšŒì „
                        }, 1000 / 60); // 60fps
                    }
                }
            } else {
                // ì•„ë¬´ê²ƒë„ intersect ë˜ì§€ ì•Šì•˜ì„ ë•Œ, ì´ì „ì— ì˜¤ë²„ëœ ëª¨ë¸ì´ ìˆë‹¤ë©´ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
                if (currentIntersected) {
                    currentIntersected.scale.copy(currentIntersected.userData.originalScale);
                    if (currentIntersected.userData.autoRotateInterval) {
                        clearInterval(currentIntersected.userData.autoRotateInterval);
                        currentIntersected.userData.autoRotateInterval = null;
                    }
                    currentIntersected = null;
                }
            }
        }

        function onThreeJsMouseLeave() {
            // ì»¨í…Œì´ë„ˆì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚¬ì„ ë•Œ, ì˜¤ë²„ëœ ëª¨ë¸ì´ ìˆë‹¤ë©´ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
            if (currentIntersected) {
                currentIntersected.scale.copy(currentIntersected.userData.originalScale);
                if (currentIntersected.userData.autoRotateInterval) {
                    clearInterval(currentIntersected.userData.autoRotateInterval);
                    currentIntersected.userData.autoRotateInterval = null;
                }
                currentIntersected = null;
            }
        }

        function onThreeJsClick(event) {
            // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì‚¬ìš©í–ˆë˜ currentIntersected ê°ì²´ í™œìš©
            if (currentIntersected && currentIntersected.userData.modelVideo) {
                const modelVideoPath = currentIntersected.userData.modelVideo;
                console.log(`ëª¨ë¸ ${currentIntersected.userData.modelName} í´ë¦­! ë¹„ë””ì˜¤: ${modelVideoPath}`);
                
                // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ë³€ê²½
                videoSource.src = modelVideoPath;
                myVideo.load(); // ë¹„ë””ì˜¤ ë‹¤ì‹œ ë¡œë“œ
                myVideo.play().catch(e => console.error("ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:", e));

                // ì¼ì • ì‹œê°„ í›„ ê¸°ë³¸ ë¹„ë””ì˜¤ë¡œ ëŒì•„ì˜¤ê¸°
                setTimeout(() => {
                    videoSource.src = BASE_VIDEO_PATH;
                    myVideo.load();
                    myVideo.play().catch(e => console.error("ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:", e));
                }, VIDEO_RESET_DELAY);
            }
        }


        // 6. ë Œë”ë§ ë£¨í”„ (ì• ë‹ˆë©”ì´ì…˜)
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // 7. ì°½ í¬ê¸° ë³€ê²½ ì‹œ í™”ë©´ ë¹„ìœ¨ ìœ ì§€ (ì›¹ìº /3D ë·°ì–´ ëª¨ë‘ ëŒ€ì‘)
        window.addEventListener('resize', () => {
            // 3D ë·°ì–´ ë¦¬ì‚¬ì´ì§•
            camera.aspect = threeJsContainer.clientWidth / threeJsContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(threeJsContainer.clientWidth, threeJsContainer.clientHeight);
        });
    </script>
</body>
</html>
